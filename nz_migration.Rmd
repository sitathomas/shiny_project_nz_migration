---
title: "Shiny Project: NZ Migration"
author: "Sita Thomas"
date: "4/27/2020"
output: html_document
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggthemes)
library(scales)

```

## Data Information

Data can be downloaded at: http://archive.stats.govt.nz/infoshare/  
Subject Categories > Tourism > International Travel and Migration

```{r preprocessing, include=F}

major_occup <- read_csv("data/major_occupations.csv", col_names = T, skip = 3)
major_occup <- major_occup[-(9:44),]
colnames(major_occup)[1] = "year"
colnames(major_occup) <- gsub("and", "", colnames(major_occup))
colnames(major_occup) <- gsub(" ", "_", colnames(major_occup))
colnames(major_occup) <- tolower(colnames(major_occup))
colnames(major_occup)[13] = "total_occupations"

by_visa_gender <-
	read_csv("data/arrivals_by_visa_gender.csv", col_names = T, skip = 4)
by_visa_gender <- by_visa_gender[-(9:41),]
colnames(by_visa_gender)[1] = "year"
females <- by_visa_gender %>%
	pivot_longer(., 2:7, names_to = "visa_type", values_to = "females") %>%
	select(., year, visa_type, females)
males <- by_visa_gender %>%
	pivot_longer(., 8:13, names_to = "visa_type", values_to = "males") %>%
	select(., year, visa_type, males) %>%
	mutate(., visa_type = gsub("_1", "", visa_type))
by_visa_gender <- inner_join(females, males, by = c("year", "visa_type")) %>% 
	pivot_longer(., 3:4, names_to = "gender", values_to = "arrivals")

by_age <-
	read_csv("data/arrivals_by_age.csv", col_names = T, skip = 4)
by_age <- by_age[-(9:41),]
colnames(by_age)[1] = "year"
age_00_04 <- by_age %>%
	pivot_longer(., 2:7, names_to = "visa_type", values_to = "age_00_04") %>%
	select(., year, visa_type, age_00_04) %>% 
	mutate(., age_00_04 = as.integer(age_00_04))
age_05_09 <- by_age %>% 
	pivot_longer(., 8:13, names_to = "visa_type", values_to = "age_05_09") %>%
	select(., year, visa_type, age_05_09) %>%
	mutate(., age_05_09 = as.integer(age_05_09),
		visa_type = gsub("_1", "", visa_type))
age_10_14 <- by_age %>%
	pivot_longer(., 14:19, names_to = "visa_type", values_to = "age_10_14") %>%
	select(., year, visa_type, age_10_14) %>%
	mutate(., age_10_14 = as.integer(age_10_14),
		visa_type = gsub("_2", "", visa_type))
age_15_19 <- by_age %>%
	pivot_longer(., 20:25, names_to = "visa_type", values_to = "age_15_19") %>%
	select(., year, visa_type, age_15_19) %>%
	mutate(., age_15_19 = as.integer(age_15_19),
		visa_type = gsub("_3", "", visa_type))
age_20_24 <- by_age %>%
	pivot_longer(., 26:31, names_to = "visa_type", values_to = "age_20_24") %>%
	select(., year, visa_type, age_20_24) %>%
	mutate(., age_20_24 = as.integer(age_20_24),
		visa_type = gsub("_4", "", visa_type))
age_25_29 <- by_age %>%
	pivot_longer(., 32:37, names_to = "visa_type", values_to = "age_25_29") %>%
	select(., year, visa_type, age_25_29) %>%
	mutate(., age_25_29 = as.integer(age_25_29),
		visa_type = gsub("_5", "", visa_type))
age_30_34 <- by_age %>%
	pivot_longer(., 38:43, names_to = "visa_type", values_to = "age_30_34") %>%
	select(., year, visa_type, age_30_34) %>%
	mutate(., age_30_34 = as.integer(age_30_34),
		visa_type = gsub("_6", "", visa_type))
age_35_39 <- by_age %>%
	pivot_longer(., 44:49, names_to = "visa_type", values_to = "age_35_39") %>%
	select(., year, visa_type, age_35_39) %>%
	mutate(., age_35_39 = as.integer(age_35_39),
		visa_type = gsub("_7", "", visa_type))
age_40_44 <- by_age %>%
	pivot_longer(., 50:55, names_to = "visa_type", values_to = "age_40_44") %>%
	select(., year, visa_type, age_40_44) %>%
	mutate(., age_40_44 = as.integer(age_40_44),
		visa_type = gsub("_8", "", visa_type))
age_45_49 <- by_age %>%
	pivot_longer(., 56:61, names_to = "visa_type", values_to = "age_45_49") %>%
	select(., year, visa_type, age_45_49) %>%
	mutate(., age_45_49 = as.integer(age_45_49),
		visa_type = gsub("_9", "", visa_type))
age_50_54 <- by_age %>%
	pivot_longer(., 62:67, names_to = "visa_type", values_to = "age_50_54") %>%
	select(., year, visa_type, age_50_54) %>%
	mutate(., age_50_54 = as.integer(age_50_54),
		visa_type = gsub("_10", "", visa_type))
age_55_59 <- by_age %>%
	pivot_longer(., 68:73, names_to = "visa_type", values_to = "age_55_59") %>%
	select(., year, visa_type, age_55_59) %>%
	mutate(., age_55_59 = as.integer(age_55_59),
		visa_type = gsub("_11", "", visa_type))
age_60_64 <- by_age %>%
	pivot_longer(., 74:79, names_to = "visa_type", values_to = "age_60_64") %>%
	select(., year, visa_type, age_60_64) %>%
	mutate(., age_60_64 = as.integer(age_60_64),
		visa_type = gsub("_12", "", visa_type))
age_65_69 <- by_age %>%
	pivot_longer(., 80:85, names_to = "visa_type", values_to = "age_65_69") %>%
	select(., year, visa_type, age_65_69) %>%
	mutate(., age_65_69 = as.integer(age_65_69),
		visa_type = gsub("_13", "", visa_type))
age_70_74 <- by_age %>%
	pivot_longer(., 86:91, names_to = "visa_type", values_to = "age_70_74") %>%
	select(., year, visa_type, age_70_74) %>%
	mutate(., age_70_74 = as.integer(age_70_74),
		visa_type = gsub("_14", "", visa_type))
age_75_up <- by_age %>%
	pivot_longer(., 92:97, names_to = "visa_type", values_to = "age_75_up") %>%
	select(., year, visa_type, age_75_up) %>%
	mutate(., age_75_up = as.integer(age_75_up),
		visa_type = gsub("_15", "", visa_type))
by_age <-
	inner_join(age_00_04, age_05_09, by = c("year", "visa_type")) %>%
	inner_join(., age_10_14, by = c("year", "visa_type")) %>%
	inner_join(., age_15_19, by = c("year", "visa_type")) %>%
	inner_join(., age_20_24, by = c("year", "visa_type")) %>%
	inner_join(., age_25_29, by = c("year", "visa_type")) %>%
	inner_join(., age_30_34, by = c("year", "visa_type")) %>%
	inner_join(., age_35_39, by = c("year", "visa_type")) %>%
	inner_join(., age_40_44, by = c("year", "visa_type")) %>%
	inner_join(., age_45_49, by = c("year", "visa_type")) %>%
	inner_join(., age_50_54, by = c("year", "visa_type")) %>%
	inner_join(., age_55_59, by = c("year", "visa_type")) %>%
	inner_join(., age_60_64, by = c("year", "visa_type")) %>%
	inner_join(., age_65_69, by = c("year", "visa_type")) %>%
	inner_join(., age_70_74, by = c("year", "visa_type")) %>% 
	inner_join(., age_75_up, by = c("year", "visa_type")) %>% 
	pivot_longer(., c(
		age_00_04, age_05_09, age_10_14, age_15_19,
		age_20_24, age_25_29, age_30_34, age_35_39,
		age_40_44, age_45_49, age_50_54, age_55_59,
		age_60_64, age_65_69, age_70_74, age_75_up
		),
		names_to = "age",
		values_to = "arrivals"
	)

```

## Exploring Net Permanent and Long-Term Migration by Year
```{r occup_by_year, echo = F}

occup_by_year <- major_occup %>% 
	group_by(year) %>% 
	summarise(., total = sum(total_occupations)) %>% 
	ggplot(., aes(x = year, y = total)) +
		geom_col(fill = "sienna3") +
		labs(
			title = "Net Permanent and Long-Term Migration to New Zealand by Year",
			subtitle = "ANZSCO Major Occupations, 2010 - 2017",
			x = "Year", y = "Arrivals") +
		theme_few()

occup_by_year

```
#### Conclusion: Exploring Net Permanent and Long-Term Migration by Year
- Although fairly level in 2016 and 2017, permanent and long-term migration to New Zealand for workers in the ANZSCO Major Occupation groups has increased throughout the 2010s.



## Exploring Net Migration by Occupation
```{r by_occupation, echo = F}

major_occup %>% 
	pivot_longer(.,
		cols = managers:labourers,
		names_to = "occupation",
		values_to = "occupation_count"
	) %>% 
	group_by(., occupation) %>% 
	summarise(., occupation_sum = sum(occupation_count)) %>% 
	ggplot(data = ., aes(y = occupation, x = occupation_sum)) +
		geom_col(fill = "sienna3") +
		labs(
			title = "Net Permanent and Long-Term Migration to New Zealand by Occupation",
			subtitle = "ANZSCO Major Occupations, 2010 - 2017",
			y = "Occupation", x = "Arrivals"
			) +
		theme_few() +
		scale_y_discrete(
			labels = c(
				"technicians__trades_workers" = "Technicians and Trades Workers",
				"sales_workers" = "Sales Workers",
				"professionals" = "Professionals",
				"managers" = "Managers",
				"machinery_operators__drivers" = "Machinery Operators and Drivers",
				"labourers" = "Laborers",
				"community__personal_service_workers" = "Community and Personal Service Workers",
				"clerical__administrative_workers" = "Clerical and Administrative Workers"
			)
		)

```
#### Conclusion: Exploring Net Permanent and Long-Term Migration by Occupation
- Most permanent and long-term migrants are Professionals by far, while more Sales Workers and Machinery Operators and Drivers have departed New Zealand than have arrived.



## Exploring Net Migration by Visa, Gender, and Age
```{r by_visa_gender, echo = F}

# ggplot(by_visa_gender, aes(x = arrivals, y = visa_type, fill = gender)) +
# 	geom_col(position = "dodge") +
# 	facet_wrap(. ~ year) # SLIDER MENU FOR R SHINY?

gender_by_year <- by_visa_gender %>%
	group_by(., year, gender) %>%
	summarise(., arrivals = sum(arrivals)) %>%
	ggplot(data = ., aes(x = year, y = arrivals, fill = gender)) +
	geom_col(position = "dodge") +
	labs(
		title = "Net Permanent and Long-Term Migration to New Zealand by Gender",
		subtitle = "2010 - 2017",
		x = "Year", y = "Arrivals",
		fill = "Gender"
	) +
	scale_y_continuous(labels = comma) +
	scale_fill_brewer(palette = "Dark2")+
	theme_few()	
gender_by_year
# Conclusion - Slightly more men tend to migrate on average, which could be due to a variety of factors, such as more opportunities in male-dominated fields, greater mobility for men, and/or greater desire or self-efficacy to migrate on the part of men.

gender_by_visa <- by_visa_gender %>% 
	group_by(., gender, visa_type) %>% 
	summarise(., arrivals = sum(arrivals)) %>% 
	ggplot(data = ., aes(x = arrivals, y = visa_type, fill = gender)) +
		geom_col(position = "dodge") +
		labs(
			title = "Net Permanent and Long-Term Migration to New Zealand by Gender and Visa Type",
			subtitle = "2010 - 2017",
			x = "Arrivals", y = "Type of Visa",
			fill = "Gender"
		) +
		scale_x_continuous(labels = comma) +
		scale_fill_brewer(palette = "Dark2")+
		theme_few()	
gender_by_visa
# Conclusion - More men than women migrate as students and for work, which is likely due to a variety of factors, such as more opportunities in male-dominated fields, greater mobility for men, and/or greater desire or self-efficacy to migrate on the part of men. More women tend to migrate for residency and to visit, who may be the wives, daughters, and mothers of men who migrate, and may therefore be more likely to seek relationship visas rather than work or student visas.

visa_by_year <- by_visa_gender %>%
	group_by(., year, visa_type) %>%
	summarise(., arrivals = sum(arrivals)) %>%
	ggplot(data = ., aes(x = year, y = arrivals, fill = visa_type)) +
		geom_col() +
		labs(
			title = "Net Permanent and Long-Term Migration to New Zealand by Type of Visa",
			subtitle = "2010 - 2017",
			x = "Year", y = "Arrivals",
			fill = "Type of Visa"
		) +
		scale_y_continuous(labels = comma) +
		scale_fill_brewer(palette = "Set3")+
		theme_few()
visa_by_year
# Conclusion - Aside from citizen movement, work visas make up the majority of migrant visas, with students following at a growing pace.
```


```{r by_age, echo = F}

age_by_year <- by_age %>%
	group_by(., year, age) %>%
	summarise(., arrivals = sum(arrivals)) %>%
	ggplot(data = ., aes(x = arrivals, y = age)) +
		geom_col(fill = "sienna3") +
		labs(
			title = "Net Permanent and Long-Term Migration to New Zealand by Age",
			subtitle = "2010 - 2017",
			x = "Arrivals", y = "Age"
		) +
	scale_x_continuous(labels = comma) +
	theme_few()
age_by_year




```

